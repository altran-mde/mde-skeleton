include::_attributes.adoc[]

[[using-3pp]]
== Using third-party products (3PP) 

Developing an Eclipse (e.g. EMF) based solution typically requires third-party products (3PP) that need to be downloaded from remote repositories.
The stability and availability of these remote repositories is often not guaranteed.
For this reason it is https://maven.apache.org/repository-management.html[recommended to use a proxy server], e.g. a Nexus or Artifactory.

Please note that these proxies might not be accessible by our clients nor by the users of our clients' solutions.
Therefore we should be aware that though these proxies should be configured in our development environments (i.e. Eclipse and CI/CD), our built solutions should depend on publicly available repositories.
The sources of some of our solutions (i.e. MDE Assets) are hosted both in our intranet as in a public GitHub.
For these solutions, it is important that they can benefit from the proxy within the intranet without modifying the sources, meaning that the proxies should be an additional configuration.

This section describes the best practices on how to configure the usage of proxy servers in the development environment our Eclipse solutions.
The following assumptions are considered when using proxies:

. The built Eclipse solution should be configured to use the publicly available repositories, and should have no dependencies on ACIDSpace (unless decided differently). +
  The Target Platform defines what your project will be built and launched against.
  See the best practices for <<eclipse-target-platform>>.
. Eclipse Oomph is used for <<setup-development-environment, setting up a development environment>>. +
  As development is typically done in the intranet, it is recommended that the Oomph setup files refer to the proxies.
. When building the solution in CI/CD it is recommended to use the proxies. +
  Our solutions are typically build using Maven, which can be configured with mirrors that reroute the public repository urls to their proxy equivalents.
  Section <<maven-repository-mirrors>> explains how to configure Maven.

[[eclipse-target-platform]]
=== Specifying an Eclipse target platform

TIP: For more detailed information on Eclipse target platforms, see https://wiki.eclipse.org/PDE/Target_Definitions

The Target Platform defines what your project will be built and launched against.
We typically <<create-oomph-setup-file, use Eclipse Oomph>> to setup an development environment.
Within our Oomph setup file, two ways of specifying a target platform are supported, either by use of https://wiki.eclipse.org/Oomph_Targlets[Oomph Targlets] or by using the https://www.eclipse.org/cbi/index.html[Eclipse CBI] target platform definition DSL.

IMPORTANT: If your target platform contains repositories that require authentication, the Eclipse CBI target platform definition DSL should be used.

Using the Eclipse CBI target platform definition DSL is preferred.
The DSL comes with an integrated Eclipse editor to author target platform files with a `tpd` file extension.
<<source-target-platform-tpd>> shows how configure the target platform for both an public repository and a proxy repository that is hosted on the intranet.

TIP: For more information on authoring Eclipse CBI `tpd` files, see https://github.com/eclipse-cbi/targetplatform-dsl#readme

[[source-target-platform-tpd]]
.Specifying the Eclipse CBI link:{giturl}/releng/com.altran.ec.mde.skeleton.target/com.altran.ec.mde.skeleton.target.tpd[target-platform.tpd^]
[source,tpd]
----
include::{gitdir}/releng/com.altran.ec.mde.skeleton.target/com.altran.ec.mde.skeleton.target.tpd[tags=doc-target-platform]
----

<1> *Public repository* - Preferably, the built Eclipse solution should be configured to use publicly available repositories.
<2> *ACIDSpace repository* - If and only if an artifact is available within ACIDSpace only, we need to specify the ACIDSpace repository url. 
    Repositories that are hosted by ACIDSpace typically require authentication.
    Specifying a repository id (i.e. `espilce-commons-p2`) allows you to configure the credentials in the Maven settings file as described in <<maven-repository-mirrors>>.
    
IMPORTANT: Whenever an Eclipse CBI `tpd` file is updated, its target platform should be regenerated by means of the context menu menu:Create TargetDefinition File[] on the `tpd` file.
When that is done, the generated target file should be activated by means of an Eclipse Oomph refresh, using the menu menu:Help[Perform Setup Tasks...] image:{imgdir}/update_gear.png[]

[[maven-repository-mirrors]]
=== Using repository mirrors in Maven

You may want to use an alternative mirror for a particular repository without changing the project files.
Some reasons to use a mirror are:

- There is a synchronized mirror on the internet that is geographically closer and faster
- You want to replace a particular repository with your own internal repository which you have greater control over
- *You want to run a repository manager to provide a local cache to a mirror and need to use its URL instead*

TIP: For more detailed information on using mirrors for repositories in Maven, see https://maven.apache.org/guides/mini/guide-mirror-settings.html

<<source-settings-xml-mirrors>> shows how to configure Maven to use repository proxies instead of the public repositories.
In this example both the https://repo1.maven.org/maven2/[Maven central] as the https://download.eclipse.org/releases/2022-12/202212071000[Eclipse 2022-12 P2] repositories are rerouted to repository proxies.

[[source-settings-xml-mirrors]]
.Defining mirrors in settings.xml
[source,xml]
----
<settings xmlns="http://maven.apache.org/SETTINGS/1.1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0
                      http://maven.apache.org/xsd/settings-1.1.0.xsd">
  <mirrors>
    <!-- Maven mirrors -->
    <mirror>
      <id>mde-assets-maven-central</id>
      <name>Maven Central Proxy</name>
      <url>https://nexus.acidspace.nl/repository/mde-assets/</url>
      <mirrorOf>central</mirrorOf> <!--1-->
    </mirror>
    <!-- P2 target platform mirrors -->
    <mirror>
      <url>https://nexus.intranet.company/repository/eclipse.org-releases-2022-12-202212071000</url>
      <mirrorOf>https://download.eclipse.org/releases/2022-12/202212071000</mirrorOf> <!--2-->
      <mirrorOfLayouts>p2</mirrorOfLayouts>
      <layout>p2</layout>
    </mirror>
  </mirrors>
  <servers>
    <!-- Maven mirrors -->
    <server>
      <id>mde-assets-maven-central</id> <!--3-->
      <configuration>
        <timeout>10000</timeout>
      </configuration>
      <username>${env.TECHNICAL_USER}</username> <!--4-->
      <password>${env.TECHNICAL_PASSWORD}</password>
    </server>
    <!-- Intranet servers in target platform -->
    <server>
      <id>espilce-commons-p2</id> <!--5-->
      <configuration>
        <timeout>10000</timeout>
      </configuration>
      <username>${env.TECHNICAL_USER}</username>
      <password>${env.TECHNICAL_PASSWORD}</password>
    </server>
  </servers>
</settings>
----

<1> *Maven repository mirror* - For Maven repository mirrors, the `<mirrorOf>` specifies the ID of the repository you are using a mirror of and the `<url>` specifies the location of the mirror, i.e. the proxy. +
    If a mirror requires authentication, a `<server>` section also needs to be configured.
<2> *Eclipse P2 repository mirror* - The `<layout>` specifies a mirror of an Eclipse P2 repository.
    In this layout, the `<mirrorOf>` specifies the url prefix of the repository to mirror.
<3> *Additional configuration for mirrors* _(Optional)_ - If a mirror requires authentication, a `<server>` section also needs to be configured.
    The `<id>` specifies the id of the server (i.e. mirror) for which these settings are applicable.
<4> *Credentials* - In CI/CD the credentials of a project can be stored in environment variables like `TECHNICAL_USER` and `TECHNICAL_PASSWORD`.
    If a server requires authentication, the credentials can be specified using these environment variables.
    Please read section <<setup-maven>> on how to setup a local machine for using Maven.
<5> *Intranet repositories* - When using proprietary artifacts that are developed and published in intranet only, authentication is required to download the artifacts.
    The `<id>` of the server should match the id as specified in the target platform, for more information see <<eclipse-target-platform>>.
    
[[bundling-eclipse-justj]]
=== Bundling a JRE with your RCP

If your solution builds an Eclipse https://wiki.eclipse.org/Rich_Client_Platform[(RCP)] application, you can make this application even more portable by including a Java(TM) JRE that is used to run the Eclipse application.
This technique saves the user the troubles of installing a JRE themselves or having a JRE installed that is not compatible with your Eclipse application.
https://www.eclipse.org/justj/[Eclipse JustJ] provides fully-functional Java(TM) runtimes that can be redistributed by Eclipse Projects.
This section describes how such an Eclipse JustJ JRE is bundled with the {project-name}.

TIP: If you have used the <<git-bootstrap, bootstrap.sh>> script with a `BOOTSTRAP-nnnn-nn-JREnn` tag to bootstrap your repository, the steps in this section already have been performed.
As such, you can also learn how to e.g. configure an Eclipse JustJ JRE17 in combination with Tycho 2.6.0 at tag link:{gitblob}/BOOTSTRAP-2022-12-JRE17/releng/com.altran.ec.mde.skeleton.parent/pom.xml[BOOTSTRAP-2022-12-JRE17^].

Start with <<eclipse-target-platform>> for Eclipse JustJ, see the code snippet below.
Please note that Eclipse JustJ provides different download locations for different JRE versions, see https://download.eclipse.org/justj/jres/ for more information.

NOTE: When using Maven, don't forget to configure an Eclipse P2 repository mirror for this repository as described in <<maven-repository-mirrors>>, also see link:{giturl}/settings.xml[settings.xml^]

.Adding Eclipse JustJ to the link:{giturl}/releng/com.altran.ec.mde.skeleton.target/com.altran.ec.mde.skeleton.target.tpd[target-platform.tpd^]
[source,tpd]
----
include::{gitdir}/releng/com.altran.ec.mde.skeleton.target/com.altran.ec.mde.skeleton.target.tpd[tags=doc-eclipse-justj]
----

Now you can simply bundle the Eclipse JustJ JRE by adding it as a dependency in the packaging feature of your Eclipse (RCP) application, see the code snippet below.

.Adding Eclipse JustJ to the pacaging link:{giturl}/products/com.altran.ec.mde.skeleton.package.feature/feature.xml[feature.xml^]
[source,xml]
----
include::{gitdir}/products/com.altran.ec.mde.skeleton.package.feature/feature.xml[tags=doc-eclipse-justj]
----
<1> This line adds the Eclipse JustJ JRE as a dependency to your Eclipse application.

When using Maven, its target platform configuration must be updated in the parent pom, see the code snippet below.
The configuration in the example is specifically for use with Tycho 1.7.0.
For newer versions of Tycho this configuration is even easier, please read the https://www.eclipse.org/justj/?page=documentation[Eclipse JustJ documentation].

IMPORTANT: For Maven it is very important that the Eclipse product file of your application (i.e. link:{giturl}/products/com.altran.ec.mde.skeleton.package.product/eclipse.product[eclipse.product^]) does not specify an execution environment.
Otherwise the Eclipse JustJ JRE jars will be published to your update site, which is undesirable.
Please ensure that the `<vm></vm>` section is empty in your eclipse.product file.

.Configuring Eclipse JustJ in the Maven parent link:{giturl}/releng/com.altran.ec.mde.skeleton.parent/pom.xml[pom.xml^]
[source,xml]
----
include::{gitdir}/releng/com.altran.ec.mde.skeleton.parent/pom.xml[tags=doc-eclipse-justj]
----
